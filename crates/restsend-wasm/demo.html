<html>

<head>
    <title>RestSend Demo</title>

<body>
    <h1>RestSend Demo</h1>
    <p>Click the button to send a request to the server.</p>
    <button onclick="sendRequest()">Send Request</button>
    <button id="btnSendTest" onclick="doTestMessage()" disabled>Send Message</button>
    <p id="response"></p>

    <script>
        var wasm = import("./pkg/restsend_wasm.js");
        wasm.then(module => {
            window.signin = module.signin;
            window.Client = module.Client;
            module.setLogging('debug');

            console.log = (text) => logText(text, 'info')
            console.error = (text) => logText(text, 'error')
            console.info = (text) => logText(text, 'info')
            console.warn = (text) => logText(text, 'warn')
        }).catch(console.error);
    </script>
    <script>
        function logText(text, level = 'info') {
            let p = document.getElementById('response');
            let item = document.createElement('div');
            item.innerText = text;
            p.appendChild(item);
        }

        async function sendRequest() {
            let endpoint = 'https://chat.ruzhila.cn'
            let info = await signin(endpoint, 'bob', 'bob:demo');
            client = new Client(info);
            client.onconnected = () => {
                logText(`client connected`);
                document.getElementById('btnSendTest').disabled = false;
            }
            await client.connect();
        }

        async function doTestMessage() {
            await client.doSendText('bob:alice', 'hello web demo', {
                onack: function (req) {
                    logText(`onack : ${JSON.stringify(req)}`);
                },
                onsent: function () {
                    logText('onsent');
                },
                onfail: function () {
                    logText('onfailed');
                }
            });
        }
    </script>
</body>

</html>